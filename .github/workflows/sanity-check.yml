name: 'pmap-resource-mapping-yml-sanity-check'
on:
  workflow_call:
jobs:
  sanity-check:
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3' # ratchet:actions/checkout@v3
        with:
          fetch-depth: 0 # OR "2" -> To retrieve the preceding commit.
      - name: 'Get changed yaml files'
        id: 'changed-yaml-files'
        uses: 'tj-actions/changed-files@79adacd43ea069e57037edc891ea8d33013bc3da' # ratchet:tj-actions/changed-files@v35
        with:
          files: |
            **/*.yaml
      - name: 'Copy added and changed files'
        if: ${{ steps.changed-yaml-files.outputs.any_changed == 'true' }}
        run: |
          echo ${{ env.RUNNER_TEMP }}
          sudo mkdir -p ${{ env.RUNNER_TEMP }}/pmap/snapshot-file-change
          for file in ${{ steps.changed-yaml-files.outputs.added_files }}; do
            echo "$file was added"
            sudo cp --parents $file ${{ env.RUNNER_TEMP }}/pmap/snapshot-file-change
            echo "$file was copied to ${{ env.RUNNER_TEMP }}/pmap/snapshot-file-change"
          done
          for file in ${{ steps.changed-yaml-files.outputs.modified_files }}; do
            echo "$file was modified"
            sudo cp --parents $file ${{ env.RUNNER_TEMP }}/pmap/snapshot-file-change
            echo "$file was copied to ${{ env.RUNNER_TEMP }}/pmap/snapshot-file-change"
          done
      - id: 'checkout-pmap'
        uses: 'actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3' # ratchet:actions/checkout@v3
        with:
          repository: 'abcxyz/pmap'
          path: 'abcxyz-pmap'
      - id: 'setup-go'
        uses: 'actions/setup-go@6edd4406fa81c3da01a34fa6f6343087c207a568' # ratchet:actions/setup-go@v3
        with:
          go-version: '1.20'
      - id: 'run-sanity-check'
        shell: 'bash'
        working-directory: 'abcxyz-pmap'
        run: 'go run ./cmd/sanity-checker ${{ env.RUNNER_TEMP }}/pmap/snapshot-file-change'

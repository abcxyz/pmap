name: 'pmap-snapshot-file-change'

on:
  workflow_call:
    inputs:
      workload_identity_provider:
        description: 'The full identifier of the Workload Identity Provider, including the project number, pool name, and provider name.'
        type: 'string'
        required: true
      service_account:
        description: 'Email address or unique identifier of the Google Cloud service account for which to generate credentials.'
        type: 'string'
        required: true
      gcs_dst_url_prefix:
        description: 'The destination prefix for the file/folder in the form bucket-name or with an optional prefix in the form bucket-name/prefix.'
        type: 'string'
        required: true

jobs:
  snapshot:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    name: 'Snapshot changed files'

    steps:
      - uses: 'actions/checkout@v3'
        with:
          fetch-depth: 0  # OR "2" -> To retrieve the preceding commit.

      - name: 'Get changed yaml files'
        id: 'changed-yaml-files'
        uses: 'tj-actions/changed-files@v35'
        with:
          files: |
            **/*.yaml

      - name: 'Copy added and changed files'
        if: steps.changed-yaml-files.outputs.any_changed == 'true'
        run: |
          echo "CUR_TIMESTAMP=$(date +'%Y-%m-%dT%H:%M:%S')" >> $GITHUB_ENV
          sudo mkdir -p /tmp/snapshot-file-change
          for file in ${{ steps.changed-yaml-files.outputs.added_files }}; do
            echo "$file was added"
            sudo cp --parents $file /tmp/snapshot-file-change
            echo "$file was copied to /tmp/snapshot-file-change"
          done
          for file in ${{ steps.changed-yaml-files.outputs.modified_files }}; do
            echo "$file was modified"
            sudo cp --parents $file /tmp/snapshot-file-change
            echo "$file was copied to /tmp/snapshot-file-change"
          done

      - name: 'Authenticate to Google Cloud'
        id: 'auth'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: '${{ inputs.workload_identity_provider }}'
          service_account: '${{ inputs.service_account }}'

      - name: 'GCS upload files'
        id: 'gcs-upload-file'
        uses: 'google-github-actions/upload-cloud-storage@v1'
        with:
          path: '/tmp/snapshot-file-change'
          parent: false
          destination: '${{ inputs.gcs_dst_url_prefix }}/${{ env.CUR_TIMESTAMP }}'

      - name: 'List all uploaded files'
        run: |
          echo "all gcs uploaded files"
          echo ${{ steps.gcs-upload-file.outputs.uploaded }}
